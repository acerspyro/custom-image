#!/bin/bash

# References:
#  * https://gitlab.com/libvirt/libvirt/-/blob/ef7c0f46f9629f6bc9537703df5b78efc2d69ab0/libvirt.spec.in#L1756
#  * https://gitlab.com/libvirt/libvirt/-/blob/ef7c0f46f9629f6bc9537703df5b78efc2d69ab0/libvirt.spec.in#L1885

# Create libvirt groups if they don't already exist
getent group 'libvirt' >/dev/null || groupadd -r 'libvirt' || :
getent group 'kvm' >/dev/null || groupadd -f -g '36' -r 'kvm' || :
getent group 'qemu' >/dev/null || groupadd -f -g '107' -r 'qemu' || :

# Create libvirt users
if ! getent passwd 'qemu' >/dev/null; then
  if ! getent passwd '107' >/dev/null; then
    useradd -r -u '107' -g 'qemu' -G 'kvm' -d '/' -s '/sbin/nologin' -c 'qemu user' 'qemu' || :
  else
    useradd -r -g 'qemu' -G 'kvm' -d '/' -s '/sbin/nologin' -c 'qemu user' 'qemu' || :
  fi
fi

# Add all sudoers to libvirt and kvm as they are system administrators anyway
gpasswd -M "$(getent group sudo | cut -d: -f4)" libvirt
gpasswd -M "$(getent group sudo | cut -d: -f4)" kvm

# # Fix libvirt socket and directory permissions
# chown root:libvirt /var/run/libvirt/libvirt-sock
# chmod 660 /var/run/libvirt/libvirt-sock

# # Fix KVM device permissions
# chown root:kvm /dev/kvm
# chmod 660 /dev/kvm

# # Fix libvirt-qemu owned directory permissions
# chown -R libvirt-qemu:libvirt-qemu /var/lib/libvirt/qemu
# chmod 700 /var/lib/libvirt/qemu

# # Fix libvirt directory permissions
# chown -R root:libvirt /var/lib/libvirt
# chown -R root:libvirt /etc/libvirt

# # Fix common libvirt runtime directory permissions
# chown root:libvirt /var/run/libvirt
# chmod 755 /var/run/libvirt
